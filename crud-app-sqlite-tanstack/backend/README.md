# Items CRUD API (SQLite Edition)

A fully functional CRUD API for managing items, refactored to use the same modern stack as the DAM project.

## Tech Stack (Matching DAM)

- **Database:** SQLite with WAL mode
- **ORM/Query Builder:** [sqlc](https://sqlc.dev/) - Compile-time safe SQL queries
- **HTTP Framework:** [Huma v2](https://huma.rocks/) - Modern OpenAPI-first framework
- **Router:** [Chi v5](https://github.com/go-chi/chi) - Lightweight, idiomatic router
- **Hot Reload:** [Air](https://github.com/air-verse/air) - Live reload for Go apps
- **Driver:** [modernc.org/sqlite](https://pkg.go.dev/modernc.org/sqlite) - Pure Go SQLite driver

## Key Features

‚úÖ **Auto-generated OpenAPI docs** at `/docs` and `/openapi.json`
‚úÖ **Type-safe database queries** with sqlc
‚úÖ **Automatic schema migration** on startup
‚úÖ **WAL mode** for better concurrency
‚úÖ **Request logging** with Chi middleware
‚úÖ **Hot reload** with Air for development
‚úÖ **Same stack as DAM** for consistency

## Architecture

```
backend/
‚îú‚îÄ‚îÄ cmd/server/main.go          # Entry point
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ api/handlers.go         # Huma API handlers
‚îÇ   ‚îú‚îÄ‚îÄ config/config.go        # Configuration
‚îÇ   ‚îú‚îÄ‚îÄ database/database.go    # DB initialization + schema application
‚îÇ   ‚îú‚îÄ‚îÄ db/                     # Generated by sqlc
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ items.sql.go        # Generated query methods
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ querier.go
‚îÇ   ‚îú‚îÄ‚îÄ services/item_service.go # Business logic
‚îÇ   ‚îî‚îÄ‚îÄ common/                 # Shared utilities (errors, slugify, etc.)
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ schema.sql              # Database schema
‚îÇ   ‚îî‚îÄ‚îÄ queries/items.sql       # SQL queries for sqlc
‚îú‚îÄ‚îÄ sqlc.yaml                   # sqlc configuration
‚îú‚îÄ‚îÄ .air.toml                   # Air hot-reload config
‚îî‚îÄ‚îÄ go.mod
```

## Database Schema

Items are stored in SQLite with the following structure:

```sql
CREATE TABLE items (
    id                TEXT PRIMARY KEY,
    slug              TEXT NOT NULL,
    name              TEXT NOT NULL,
    text              TEXT,
    is_completed      BOOLEAN NOT NULL DEFAULT 0,
    priority          TEXT NOT NULL DEFAULT 'mid',
    tags              TEXT, -- JSON array
    categories        TEXT NOT NULL, -- JSON array (exactly one category)
    created_at        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**Indexes:**
- `idx_items_slug` on `slug`
- `idx_items_is_completed` on `is_completed`
- `idx_items_priority` on `priority`
- `idx_items_created_at` on `created_at`

**Triggers:**
- Auto-update `updated_at` timestamp on every update

## API Endpoints

All responses follow this format:
```json
{
  "success": true,
  "data": { ... }
}
```

### Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/health` | Health check |
| `GET` | `/docs` | Interactive OpenAPI documentation |
| `GET` | `/openapi.json` | OpenAPI spec |
| `GET` | `/api/items/tree` | Get all items organized by category |
| `POST` | `/api/items` | Create a new item |
| `GET` | `/api/items/{categorySlug}/{itemSlug}` | Get a specific item |
| `PATCH` | `/api/items/{categorySlug}/{itemSlug}` | Update an item |
| `DELETE` | `/api/items/{categorySlug}/{itemSlug}` | Delete an item |

## Running the Server

### Prerequisites

- Go 1.23+ installed
- `sqlc` installed (for regenerating queries): `go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest`
- `air` installed (for hot reload): `go install github.com/air-verse/air@latest`

### Quick Start

**Option 1: Using Makefile (Recommended)**
```bash
cd backend

# First time setup (install deps + generate code)
make setup

# Run with hot reload (auto-generates code if needed)
make dev

# OR run without hot reload
make run

# See all available commands
make help
```

**Option 2: Manual Commands**
```bash
cd backend

# Install dependencies
go mod download

# Generate sqlc code (required on first run or after SQL changes)
sqlc generate

# Run with hot reload
air

# OR run directly
go run ./cmd/server/main.go
```

**‚ö†Ô∏è IMPORTANT:**
- **Makefile commands** (`make dev`, `make run`) automatically run `sqlc generate` if needed ‚úÖ
- When using `air` directly, it auto-runs `scripts/ensure-sqlc.sh` before each build ‚úÖ
- If running `go run` directly, you MUST run `sqlc generate` manually first ‚ö†Ô∏è
- After changing `.sql` files, regenerate with `sqlc generate` or `make generate`

The server will:
1. Initialize SQLite database at `./data/items.db`
2. Apply schema automatically
3. Start on port `3000` (configurable)
4. Print startup logs with emojis ‚úÖüöÄüìö

### Environment Variables

- `ITEMS_PORT`: Port to run the API on (default: `3000`)
- `ITEMS_DATA_PATH`: Path to the data directory (default: `./data`)
- `DATABASE_URL`: SQLite database path (default: `./data/items.db`)

## Example Usage

### Create an item

```bash
curl -X POST http://localhost:3000/api/items \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Buy groceries",
    "text": "Get milk, bread, and eggs",
    "priority": "high",
    "tags": ["shopping", "food"],
    "categories": ["personal"]
  }'
```

Response:
```json
{
  "success": true,
  "data": {
    "id": "f47ac10b-...",
    "slug": "buy-groceries",
    "name": "Buy groceries",
    "text": "Get milk, bread, and eggs",
    "isCompleted": false,
    "priority": "high",
    "tags": ["shopping", "food"],
    "categories": ["personal"],
    "createdAt": "2025-11-16T10:30:00Z",
    "updatedAt": "2025-11-16T10:30:00Z"
  }
}
```

### Get all items (tree view)

```bash
curl http://localhost:3000/api/items/tree
```

Response:
```json
{
  "success": true,
  "data": {
    "personal": [
      {
        "id": "f47ac10b-...",
        "slug": "buy-groceries",
        "name": "Buy groceries",
        ...
      }
    ],
    "work": [...]
  }
}
```

### Get a specific item

```bash
curl http://localhost:3000/api/items/personal/buy-groceries
```

### Update an item

```bash
curl -X PATCH http://localhost:3000/api/items/personal/buy-groceries \
  -H "Content-Type: application/json" \
  -d '{
    "isCompleted": true
  }'
```

### Delete an item

```bash
curl -X DELETE http://localhost:3000/api/items/personal/buy-groceries
```

## Development Workflow

### Modify Database Schema

1. Edit `db/schema.sql`
2. Run schema migration: `go run ./cmd/server/main.go` (applies automatically)

### Modify SQL Queries

1. Edit `db/queries/items.sql`
2. Regenerate Go code: `sqlc generate`
3. The generated code appears in `internal/db/`

### Hot Reload with Air

When using `air`, the server automatically rebuilds and restarts when you change:
- `.go` files
- `.sql` files
- Templates (if any)

## Production Build

To create a static binary for deployment:

```bash
cd backend
go build -ldflags="-w -s" -o items-api ./cmd/server
```

Then run:
```bash
./items-api
```

## Key Differences from Original crud-app

| Feature | Original (./crud-app) | Refactored (./crud-app-sqlite) |
|---------|----------------------|--------------------------------|
| Storage | YAML files | SQLite database |
| Queries | File system operations | Type-safe sqlc queries |
| API Framework | Raw Chi handlers | Huma v2 (OpenAPI-first) |
| Documentation | None | Auto-generated at `/docs` |
| Hot Reload | Manual restart | Air (automatic) |
| Schema | Implicit (file structure) | Explicit (schema.sql) |
| Logging | Basic fmt.Println | Chi middleware.Logger |
| Database Setup | N/A | Automatic schema application |

## Database Configuration (Matching DAM)

The database is configured with optimal settings for SQLite:

```go
PRAGMA foreign_keys = ON           // Enforce foreign key constraints
PRAGMA journal_mode = WAL          // Write-Ahead Logging for concurrency
PRAGMA busy_timeout = 5000         // Wait 5s on lock
PRAGMA synchronous = NORMAL        // Balance safety/speed
PRAGMA cache_size = -64000         // 64MB cache
PRAGMA temp_store = MEMORY         // Keep temp tables in RAM
```

Connection pool: `MaxOpenConns=1`, `MaxIdleConns=1` (SQLite single-writer optimization)

## Troubleshooting

### "Database locked" errors
The server uses WAL mode and connection pool limits to prevent this. If it still occurs, check that no other process is accessing the database.

### Schema not applying
Delete `./data/items.db` and restart. The schema applies automatically on startup.

### Port already in use
Change the port: `ITEMS_PORT=3001 go run ./cmd/server/main.go`

## Testing

Visit the interactive API documentation at `http://localhost:3000/docs` to test all endpoints in your browser.

---

**Status:** ‚úÖ Fully functional backend matching DAM stack (SQLite + Huma + Chi + sqlc + Air)
